@namespace WebScraping
@page "/"
@inject HttpClient HttpClient

<h3>Collected Links</h3>
<div class="container mt-3">
    <div class="form-group mb-3">
        <label for="urlInput">Enter URL</label>
        <input type="text" class="form-control" id="urlInput" @bind="inputUrl" placeholder="Enter URL" />
    </div>
    <div class="form-group mb-3">
        <label for="minutesInput">Enter Minutes</label>
        <input type="number" class="form-control" id="minutesInput" @bind="maxMinutes" placeholder="Enter Minutes" />
    </div>
    <div class="form-group mb-3">
        <label for="depthInput">Enter Depth</label>
        <input type="number" class="form-control" id="depthInput" @bind="maxDepth" placeholder="Enter Depth" />
    </div>
    <div class="form-group mb-3">
        <label for="textInput">Optional Text Filter</label>
        <input type="text" class="form-control" id="textInput" @bind="optionalText" placeholder="Enter text to filter URLs" />
    </div>
    <button class="btn btn-primary" @onclick="FetchAndSaveLinks">Fetch Links</button>
</div>

@if (isFetching)
{
    <div class="alert alert-info mt-3">Fetching links...</div>
}

@if (isFetchComplete)
{
    <div class="alert alert-success mt-3">All links have been fetched successfully!</div>
}

@if (isTimeout)
{
    <div class="alert alert-danger mt-3">Fetching links timed out.</div>
}

<ul class="list-group mt-3">
    @foreach (var data in scrapedDataList)
    {
        <li class="list-group-item">
            <strong>URL:</strong> <a href="@data.Url" target="_blank">@data.Url</a>
            @if (data.Emails.Any())
            {
                <div>
                    <strong>Emails:</strong>
                    <ul>
                        @foreach (var email in data.Emails)
                        {
                            <li>@email</li>
                        }
                    </ul>
                </div>
            }
            @if (data.PhoneNumbers.Any())
            {
                <div>
                    <strong>Phone Numbers:</strong>
                    <ul>
                        @foreach (var phoneNumber in data.PhoneNumbers)
                        {
                            <li>@phoneNumber</li>
                        }
                    </ul>
                </div>
            }
        </li>
    }
</ul>

@code {
    private List<ScrapedData> scrapedDataList = new List<ScrapedData>(); // List to store the scraped data
    private string inputUrl = string.Empty;
    private int maxMinutes = 1; // Maximum number of minutes to run the task
    private int maxDepth = 2; // Maximum recursion depth
    private string optionalText = string.Empty; // Optional text to filter URLs
    private bool isFetching = false;
    private bool isFetchComplete = false;
    private bool isTimeout = false;

    private async Task FetchAndSaveLinks()
    {
        if (string.IsNullOrEmpty(inputUrl))
        {
            return; // Don't proceed if the URL is empty
        }

        isFetching = true;
        isFetchComplete = false;
        isTimeout = false;
        StateHasChanged(); // Update the UI

        try
        {
            var response = await HttpClient.GetAsync($"api/proxy/fetchLinks?url={inputUrl}&maxDepth={maxDepth}&maxMinutes={maxMinutes}&filterText={optionalText}");
            if (response.IsSuccessStatusCode)
            {
                scrapedDataList = await response.Content.ReadFromJsonAsync<List<ScrapedData>>();
                isFetchComplete = true;
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.RequestTimeout)
            {
                isTimeout = true;
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error fetching links: {ex.Message}");
        }
        finally
        {
            isFetching = false;
            StateHasChanged(); // Update the UI
        }
    }

    public class ScrapedData
    {
        public string Url { get; set; }
        public List<string> Emails { get; set; }
        public List<string> PhoneNumbers { get; set; }
    }
}
