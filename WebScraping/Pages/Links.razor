@page "/"
@inject HttpClient HttpClient

<h3>Collected Links</h3>
<div>
    <InputText @bind-Value="inputUrl" placeholder="Enter URL" />
    <InputNumber @bind-Value="maxMinutes" placeholder="Enter Minutes" />
    <button @onclick="FetchAndSaveLinks">Fetch Links</button>
</div>

@if (isFetching)
{
    <p>Fetching links...</p>
}

@if (isFetchComplete)
{
    <p>All links have been fetched successfully!</p>
}

@if (isTimeout)
{
    <p>Fetching links timed out.</p>
}

<ul>
    @foreach (var link in uniqueLinks)
    {
        <li>
            <a href="@link" target="_blank">@link</a>
        </li>
    }
</ul>

@code {
    private List<string> uniqueLinks = new(); // List to display unique links
    private string inputUrl = string.Empty;
    private int maxMinutes = 1; // Maximum number of minutes to run the task
    private bool isFetching = false;
    private bool isFetchComplete = false;
    private bool isTimeout = false;

    private async Task FetchAndSaveLinks()
    {
        if (string.IsNullOrEmpty(inputUrl))
        {
            return; // Don't proceed if the URL is empty
        }

        isFetching = true;
        isFetchComplete = false;
        isTimeout = false;
        StateHasChanged(); // Update the UI

        try
        {
            var response = await HttpClient.GetAsync($"api/proxy/fetchLinks?url={Uri.EscapeDataString(inputUrl)}&maxDepth=2&maxMinutes={maxMinutes}");
            if (response.IsSuccessStatusCode)
            {
                var links = await response.Content.ReadFromJsonAsync<HashSet<string>>();
                uniqueLinks = links.ToList();
                isFetchComplete = true;
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.RequestTimeout)
            {
                isTimeout = true;
            }
            else
            {
                Console.WriteLine($"Failed to fetch links: {response.StatusCode}");
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Exception occurred: {ex.Message}");
        }
        finally
        {
            isFetching = false;
            StateHasChanged(); // Update the UI
        }
    }
}
